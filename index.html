<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù†ØµØ© Ø­Ù…ÙŠØ¯ | Ø´Ø§Ø´Ø© ÙƒØ§Ù…Ù„Ø©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://assets.mediadelivery.net/playerjs/player-0.1.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Tajawal', 'sans-serif'] },
                    colors: {
                        'brand': { 50: '#f5f3ff', 100: '#ede9fe', 500: '#8b5cf6', 600: '#7c3aed', 900: '#4c1d95' },
                        'accent': { 500: '#06b6d4' }
                    }
                }
            }
        }
    </script>

    <style>
        body { background: #f8fafc; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .animate-enter { animation: slideInUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .lecture-item.completed .status-overlay { opacity: 1; background: rgba(16, 185, 129, 0.9); }
        .lecture-item.completed .lec-title { text-decoration: line-through; color: #94a3b8; }
        .lecture-item.completed img { filter: grayscale(100%); }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…ØªØ¬Ø§ÙˆØ¨Ø© */
        .video-wrapper-responsive {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        .video-container { 
            position: relative; 
            width: 100%;
            aspect-ratio: 16 / 9; 
            background: #000; 
            overflow: hidden; 
            box-shadow: 0 20px 50px -10px rgba(0,0,0,0.8);
        }
        .video-container iframe { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;
        }
        @media (min-width: 768px) {
            .video-container {
                border-radius: 16px;
                max-width: 85%;
                max-height: 85vh;
            }
        }
        @media (max-width: 767px) {
            .video-container { border-radius: 0; width: 100%; }
        }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 20px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .countdown-segment { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            background: rgba(255, 255, 255, 0.15); 
            border-radius: 12px; 
            padding: 8px 0;
            width: 25%;
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="text-slate-800 h-[100dvh] flex flex-col bg-slate-50">

    <canvas id="confetti-canvas" class="fixed inset-0 pointer-events-none z-[100]"></canvas>

    <div id="loginScreen" class="fixed inset-0 z-[60] flex flex-col items-center justify-center bg-slate-900/95 backdrop-blur-xl transition-all duration-500">
        <div class="w-full max-w-sm p-8 text-center animate-enter">
            <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-tr from-brand-600 to-accent-500 rounded-3xl flex items-center justify-center shadow-lg shadow-brand-500/30">
                <i class="fa-solid fa-graduation-cap text-4xl text-white"></i>
            </div>
            <h1 class="text-3xl font-black text-white mb-8">Ù…Ù†ØµØ© Ø­Ù…ÙŠØ¯</h1>
            <input type="password" id="passwordInput" placeholder="Ø§Ù„Ø±Ù…Ø² (123)" class="w-full p-4 bg-white/10 rounded-xl text-white text-center text-xl font-bold border border-white/10 focus:border-brand-500 outline-none mb-4 transition-colors">
            <button onclick="checkLogin()" class="w-full bg-brand-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-brand-500 transition-all">Ø·Ø¨ Ù„Ù„Ù…Ù†ØµØ©</button>
            <p id="errorMsg" class="text-rose-400 mt-4 hidden font-bold text-sm">Ø§Ù„Ø±Ù…Ø² ØºÙ„Ø· Ø£ØºØ§ØªÙŠ!</p>
        </div>
    </div>

    <div id="appScreen" class="hidden flex flex-col h-full w-full bg-white text-slate-800">
        
        <header class="px-6 pt-4 pb-4 bg-white/95 backdrop-blur-md sticky top-0 z-20 border-b border-slate-200 shadow-sm">
            <div class="max-w-[1920px] mx-auto w-full">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-brand-600 flex items-center justify-center text-white shadow-lg shadow-brand-500/20">
                            <i class="fa-solid fa-graduation-cap text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-black text-slate-800" id="greetingMsg">Ù‡Ù„Ø§ ÙˆØ§Ù„Ù„Ù‡!</h1>
                            <p class="text-xs text-slate-500 font-bold" id="dateDisplay">--</p>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 items-center">
                        <div class="hidden md:block text-center px-4 py-2 bg-slate-50 rounded-xl border border-slate-100">
                            <span class="block text-[10px] text-slate-400 font-bold">Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ù†Ø¬Ø§Ø²</span>
                            <span class="text-xl font-black text-brand-600" id="percentageText">0%</span>
                        </div>
                        <button onclick="logout()" class="w-10 h-10 rounded-xl bg-rose-50 text-rose-500 flex items-center justify-center hover:bg-rose-500 hover:text-white transition-all"><i class="fa-solid fa-right-from-bracket"></i></button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 items-stretch">
                    <div id="dateCountdownCard" class="bg-gradient-to-r from-brand-600 to-brand-500 p-4 rounded-xl text-white shadow-lg shadow-brand-500/20 flex flex-col justify-between">
                        <div class="flex justify-between items-center border-b border-white/20 pb-2 mb-2">
                            <h3 class="font-bold text-sm"><i class="fa-solid fa-hourglass-half ml-2"></i> Ø¨Ø§Ù‚ÙŠ Ø¹Ù„Ù‰ Ù†ØµÙ Ø§Ù„Ø³Ù†Ø©</h3>
                            <span id="currentDayOfWeek" class="font-bold text-xs bg-white/20 px-2 py-0.5 rounded-full text-white">--</span>
                        </div>
                        <div id="countdownTimer" class="flex justify-between gap-2 font-mono text-center w-full"></div>
                    </div>

                    <div class="lg:col-span-2 flex flex-col gap-3 justify-center">
                        <div id="apiFetcherArea" class="hidden">
                             <button onclick="fetchAllDurationsFromAPI()" class="w-full py-3 bg-slate-800 text-white rounded-xl text-sm font-bold hover:bg-slate-700 transition flex items-center justify-center gap-2 shadow-md"><i class="fa-solid fa-cloud-arrow-down"></i> ØªØ­Ø¯ÙŠØ« Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª (API)</button>
                        </div>
                        <div class="relative h-full">
                            <i class="fa-solid fa-search absolute right-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø­Ø§Ø¶Ø±Ø©ØŒ Ù…ÙˆØ¶ÙˆØ¹ØŒ Ø§Ùˆ Ù…Ø¯Ø±Ø³..." class="w-full h-full bg-slate-100/80 rounded-xl px-4 py-3 pr-10 pl-4 text-base font-bold text-slate-700 outline-none focus:bg-white focus:ring-2 ring-brand-200 transition-all border border-transparent focus:border-brand-300">
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto px-6 py-6 pb-32 scroll-smooth bg-slate-50">
            <div class="max-w-[1920px] mx-auto w-full">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div id="smartScheduleCard" class="md:col-span-2 bg-white border border-slate-200 rounded-2xl p-5 shadow-sm hidden animate-enter">
                        <div class="flex items-center gap-2 mb-4">
                            <div class="w-8 h-8 rounded-lg bg-brand-50 flex items-center justify-center text-brand-600"><i class="fa-regular fa-calendar-check"></i></div>
                            <h3 class="font-black text-slate-800">Ø¬Ø¯ÙˆÙ„Ùƒ Ù„Ù„ÙŠÙˆÙ…</h3>
                        </div>
                        <div id="scheduleContent" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                    </div>

                    <div id="resumeContainer" class="hidden animate-enter">
                        <button onclick="resumeLastWatched()" class="w-full h-full bg-white border border-brand-100 p-5 rounded-2xl flex flex-col justify-center items-start gap-3 hover:shadow-lg hover:border-brand-200 transition-all group">
                            <div class="flex items-center gap-3 w-full">
                                <div class="w-12 h-12 rounded-full bg-brand-50 group-hover:bg-brand-500 group-hover:text-white transition-colors flex items-center justify-center text-brand-600 text-xl"><i class="fa-solid fa-play ml-1"></i></div>
                                <div>
                                    <span class="text-[10px] text-slate-400 font-bold uppercase block mb-0.5">Ø§Ø®Ø± Ø´ÙŠ Ø´ÙØªÙ‡</span>
                                    <h4 class="font-black text-slate-800 text-base line-clamp-1 text-right" id="resumeTitle">...</h4>
                                </div>
                            </div>
                            <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden mt-2">
                                <div class="bg-brand-500 h-full w-2/3"></div>
                            </div>
                        </button>
                    </div>
                </div>

                <div id="loadingText" class="text-center py-20 text-slate-400">
                    <i class="fa-solid fa-circle-notch fa-spin text-3xl mb-4 text-brand-300"></i>
                    <p class="text-base font-bold">Ø¯Ø§ Ù†Ø­Ù…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
                </div>

                <div id="dynamicListContainer" class="space-y-8"></div>
            </div>
        </main>
    </div>

    <div id="videoModal" class="fixed inset-0 z-[100] bg-black hidden flex flex-col opacity-0 transition-opacity duration-300">
        <div class="p-4 flex justify-between items-center bg-white/10 backdrop-blur-md z-10">
            <h2 class="text-white font-bold text-lg truncate flex-1 pl-4" id="modalTitle">Ø¹Ù†ÙˆØ§Ù†</h2>
            <button onclick="closeVideoModal()" class="text-white w-10 h-10 rounded-full bg-white/10 flex items-center justify-center hover:bg-rose-600 transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        <div class="flex-1 video-wrapper-responsive relative bg-black">
            <div class="video-container shadow-2xl">
                <div id="videoContainer" class="w-full h-full"></div>
            </div>
        </div>
        <div class="p-6 bg-black flex justify-center z-10 pb-10 sm:pb-6">
            <button id="markCompleteBtn" onclick="completeFromPlayer()" class="bg-brand-600 text-white px-10 py-4 rounded-xl font-bold text-lg shadow-lg shadow-brand-600/30 active:scale-95 transition-transform flex items-center gap-3 hover:bg-brand-500">
                <i class="fa-solid fa-check"></i> <span>ØªÙ…ØŒ ÙƒÙ…Ù„ØªÙ‡Ø§</span>
            </button>
        </div>
    </div>

    <script>
        const BUNNY_API_KEY = "071eadcd-7e8e-4840-90403f7fa8d2-1628-4800"; 
        const BUNNY_LIBRARY_ID = "572295"; 
        const PASSWORD = "123";
        const THUMBNAIL_BASE = "https://vz-dccdba03-a7d.b-cdn.net"; 
        
        let allData = [];
        let completedLectures = JSON.parse(localStorage.getItem('hameed_completed_v3')) || [];
        let savedDurations = JSON.parse(localStorage.getItem('hameed_durations')) || {};
        let currentPlayingId = null;
        let playerInstance = null; 

        function checkLogin() {
            if(document.getElementById('passwordInput').value === PASSWORD) {
                localStorage.setItem('hameed_loggedIn', 'true');
                document.getElementById('loginScreen').classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => {
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('appScreen').classList.remove('hidden');
                    loadData();
                }, 500);
            } else {
                document.getElementById('errorMsg').classList.remove('hidden');
            }
        }
        function logout() { localStorage.removeItem('hameed_loggedIn'); location.reload(); }

        async function loadData() {
            try {
                if(BUNNY_API_KEY && BUNNY_LIBRARY_ID) document.getElementById('apiFetcherArea').classList.remove('hidden');
                const response = await fetch('data.json');
                if(!response.ok) throw new Error();
                const raw = await response.json();
                allData = raw.teachers.map((t, ti) => ({
                    ...t, classes: t.classes.map((c, ci) => ({
                        ...c, lectures: c.lectures.map((l, li) => ({
                            ...l, id: l.id || `lec_${ti}_${ci}_${li}`
                        }))
                    }))
                }));
                document.getElementById('loadingText').classList.add('hidden');
                renderApp(allData);
                updateStats();
                updateSmartSchedule();
                checkLastWatched();
                updateDateTime();
                setupCountdown();
            } catch(e) {
                document.getElementById('loadingText').innerHTML = "ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù (data.json)";
            }
        }

        function updateDateTime() {
            const today = new Date();
            document.getElementById('dateDisplay').innerText = today.toLocaleDateString('ar-IQ', {weekday:'long', day:'numeric', month:'long'});
            document.getElementById('currentDayOfWeek').innerText = today.toLocaleDateString('ar-IQ', {weekday:'long'});
        }

        function setupCountdown() {
            const countdownElement = document.getElementById('countdownTimer');
            const now = new Date();
            const targetYear = now.getMonth() < 1 ? now.getFullYear() : now.getFullYear() + 1;
            const targetDate = new Date(targetYear, 0, 20);
            if (targetDate.getTime() < now.getTime()) {
                countdownElement.innerHTML = '<span class="text-lg font-bold">ğŸ‰ Ø®Ù„ØµØª! Ø¨Ø§Ù„ØªÙˆÙÙŠÙ‚!</span>';
                return;
            }
            function updateCountdown() {
                const now = new Date().getTime();
                const distance = targetDate.getTime() - now;
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                if (distance < 0) {
                    clearInterval(countdownInterval);
                    countdownElement.innerHTML = '<span class="text-lg font-bold">ğŸ‰ Ø®Ù„ØµØª! Ø¨Ø§Ù„ØªÙˆÙÙŠÙ‚!</span>';
                    return;
                }
                countdownElement.innerHTML = `
                    <div class="countdown-segment"><span class="text-xl md:text-2xl font-black">${days}</span><span class="text-[10px]">ÙŠÙˆÙ…</span></div>
                    <div class="countdown-segment"><span class="text-xl md:text-2xl font-black">${hours < 10 ? '0' + hours : hours}</span><span class="text-[10px]">Ø³Ø§Ø¹Ø©</span></div>
                    <div class="countdown-segment"><span class="text-xl md:text-2xl font-black">${minutes < 10 ? '0' + minutes : minutes}</span><span class="text-[10px]">Ø¯Ù‚ÙŠÙ‚Ø©</span></div>
                    <div class="countdown-segment"><span class="text-xl md:text-2xl font-black">${seconds < 10 ? '0' + seconds : seconds}</span><span class="text-[10px]">Ø«Ø§Ù†ÙŠØ©</span></div>
                `;
            }
            const countdownInterval = setInterval(updateCountdown, 1000);
            updateCountdown();
        }

        function getThumbnailUrl(videoUrl) {
            try {
                const NO_THUMBNAIL_URL = 'https://via.placeholder.com/150x100?text=No+Video';
                if (!videoUrl || videoUrl === '#' || !videoUrl.includes('mediadelivery.net')) return NO_THUMBNAIL_URL;
                const videoId = videoUrl.split('/').pop().split('?')[0];
                if(videoId) return `${THUMBNAIL_BASE}/${videoId}/thumbnail.jpg`;
                return NO_THUMBNAIL_URL;
            } catch (e) { return 'https://via.placeholder.com/150x100?text=Error'; }
        }

        function formatTime(totalSeconds) {
            if (!totalSeconds || isNaN(totalSeconds) || totalSeconds <= 0) return '--:--';
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            let timeStr = `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
            if (hours > 0) timeStr = `${hours}:${minutes < 10 ? '0' + minutes : minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
            return timeStr;
        }

        async function fetchAllDurationsFromAPI() {
            if (!BUNNY_API_KEY || !BUNNY_LIBRARY_ID) { alert("Ø£Ø¶Ù API Key!"); return; }
            const btn = document.querySelector('#apiFetcherArea button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            btn.disabled = true;
            try {
                for (const teacher of allData) {
                    for (const cls of teacher.classes) {
                        for (const lec of cls.lectures) {
                            if (lec.url && lec.url.includes('mediadelivery')) {
                                const videoId = lec.url.split('/').pop().split('?')[0];
                                if (videoId && !savedDurations[lec.id]) {
                                    try {
                                        const res = await fetch(`https://video.bunnycdn.com/library/${BUNNY_LIBRARY_ID}/videos/${videoId}`, {
                                            method: 'GET',
                                            headers: { 'AccessKey': BUNNY_API_KEY, 'Accept': 'application/json' }
                                        });
                                        if (res.ok) {
                                            const data = await res.json();
                                            if (data.length) saveDuration(lec.id, data.length);
                                        }
                                    } catch (err) { console.error(err); }
                                }
                            }
                        }
                    }
                }
                alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«!");
            } catch (error) { alert("Ø®Ø·Ø£ API"); }
            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        function saveDuration(id, seconds) {
            const timeStr = formatTime(seconds);
            if (savedDurations[id] !== timeStr) {
                savedDurations[id] = timeStr;
                localStorage.setItem('hameed_durations', JSON.stringify(savedDurations));
                const badge = document.getElementById(`dur_img_${id}`);
                if (badge) badge.innerText = timeStr;
            }
        }

        function renderApp(data) {
            const container = document.getElementById('dynamicListContainer');
            container.innerHTML = '';
            data.forEach((teacher, ti) => {
                const section = document.createElement('div');
                section.className = "animate-enter";
                section.style.animationDelay = `${ti * 100}ms`;
                let classesHtml = '';
                teacher.classes.forEach((cls, ci) => {
                    let lecsHtml = '';
                    cls.lectures.forEach(lec => {
                        const isDone = completedLectures.includes(lec.id);
                        const duration = savedDurations[lec.id] || '--:--'; 
                        const thumbUrl = getThumbnailUrl(lec.url);
                        // Ù‡Ù†Ø§ Ø§Ù„ØªØºÙŠÙŠØ±: Ø§Ø³ØªØ®Ø¯Ø§Ù… Grid Ø¯Ø§Ø®Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ù„ØªÙˆØ²ÙŠØ¹Ù‡Ø§ Ø¨Ø§Ù„Ø¹Ø±Ø¶
                        lecsHtml += `
                            <div id="row_${lec.id}" class="lecture-item ${isDone ? 'completed' : ''} group bg-white rounded-2xl border border-slate-100 hover:border-brand-300 hover:shadow-xl transition-all duration-300 overflow-hidden flex flex-col">
                                <div class="relative aspect-video cursor-pointer overflow-hidden" onclick="openPlayer('${lec.title.replace(/'/g, "\\'")}', '${lec.url}', '${lec.id}')">
                                    <img src="${thumbUrl}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 bg-slate-200" onerror="this.src='https://via.placeholder.com/300x170?text=No+Img'">
                                    <div class="absolute inset-0 bg-black/20 group-hover:bg-black/10 transition-colors flex items-center justify-center">
                                        <div class="w-12 h-12 rounded-full bg-white/30 backdrop-blur-md flex items-center justify-center text-white scale-90 group-hover:scale-110 transition-transform shadow-lg"><i class="fa-solid fa-play pl-1"></i></div>
                                    </div>
                                    <div class="absolute bottom-2 left-2 bg-black/70 backdrop-blur-sm px-2 py-0.5 rounded-md text-[10px] text-white font-bold dir-ltr font-mono flex items-center gap-1">
                                        <i class="fa-regular fa-clock text-[9px]"></i><span id="dur_img_${lec.id}">${duration}</span>
                                    </div>
                                    ${isDone ? '<div class="absolute top-2 right-2 bg-green-500 text-white text-xs px-2 py-1 rounded-md font-bold shadow-sm"><i class="fa-solid fa-check ml-1"></i> Ù…ÙƒØªÙ…Ù„</div>' : ''}
                                </div>
                                <div class="p-4 flex flex-col flex-1">
                                    <h3 class="lec-title text-base font-bold text-slate-800 leading-snug mb-2 line-clamp-2" title="${lec.title}">${lec.title}</h3>
                                    ${lec.description ? `<p class="text-xs text-slate-400 line-clamp-2 mb-3">${lec.description}</p>` : ''}
                                    <div class="mt-auto flex justify-between items-center pt-3 border-t border-slate-50">
                                        <span class="text-[10px] bg-slate-50 text-slate-400 px-2 py-1 rounded border border-slate-100">ÙÙŠØ¯ÙŠÙˆ Ù…Ø³Ø¬Ù„</span>
                                        <button onclick="toggleComplete('${lec.id}')" class="status-btn text-xs font-bold text-slate-400 hover:text-brand-600 transition-colors">
                                            ${isDone ? 'ØªØ±Ø§Ø¬Ø¹' : 'ØªØ­Ø¯ÙŠØ¯ ÙƒÙ…Ù†Ø¬Ø²'}
                                        </button>
                                    </div>
                                </div>
                            </div>`;
                    });
                    
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Grid Columns Ù‡Ù†Ø§ Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙƒØ±ÙˆØª
                    classesHtml += `
                        <details class="group mb-6 bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden" ${ci === 0 ? 'open' : ''}>
                            <summary class="flex items-center justify-between p-5 cursor-pointer list-none bg-slate-50/50 hover:bg-slate-50 transition-colors select-none">
                                <span class="flex items-center gap-3">
                                    <span class="w-2 h-8 rounded-full bg-brand-500"></span>
                                    <span class="font-black text-lg text-slate-700">${cls.name}</span>
                                    <span class="text-xs font-medium bg-white px-2 py-1 rounded-md border border-slate-200 text-slate-400">${cls.lectures.length} Ù…Ø­Ø§Ø¶Ø±Ø§Øª</span>
                                </span>
                                <i class="fa-solid fa-chevron-down text-slate-400 transition-transform duration-300 group-open:rotate-180"></i>
                            </summary>
                            <div class="p-5 bg-white border-t border-slate-100">
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
                                    ${lecsHtml}
                                </div>
                            </div>
                        </details>`;
                });
                section.innerHTML = `
                    <div class="flex items-center gap-5 mb-6 px-2">
                        <img src="${teacher.image}" class="w-20 h-20 rounded-2xl bg-white p-1 object-cover shadow-md border border-slate-100">
                        <div>
                            <h2 class="font-black text-2xl text-slate-800 mb-1">${teacher.name}</h2>
                            <span class="inline-block text-xs bg-brand-50 text-brand-600 px-3 py-1.5 rounded-lg font-bold border border-brand-100">${teacher.subject}</span>
                        </div>
                    </div>
                    ${classesHtml}`;
                container.appendChild(section);
            });
        }

        function toggleComplete(id) {
            const row = document.getElementById(`row_${id}`);
            if (completedLectures.includes(id)) {
                completedLectures = completedLectures.filter(i => i !== id);
                renderApp(allData); // Re-render to update UI properly
            } else {
                completedLectures.push(id);
                triggerConfetti();
                renderApp(allData);
            }
            localStorage.setItem('hameed_completed_v3', JSON.stringify(completedLectures));
            updateStats();
            updateSmartSchedule();
        }

        function openPlayer(title, url, id) {
            if(!url || url === '#') { alert('Ù…Ø§ÙƒÙˆ Ø±Ø§Ø¨Ø·!'); return; }
            currentPlayingId = id;
            let finalUrl = url;
            if (!finalUrl.includes('?')) finalUrl += '?context=true';
            else finalUrl += '&context=true';

            document.getElementById('modalTitle').innerText = title;
            const modal = document.getElementById('videoModal');
            modal.classList.remove('hidden');
            setTimeout(()=>modal.classList.remove('opacity-0'), 10);
            
            const container = document.getElementById('videoContainer');
            container.innerHTML = `<iframe id="activeFrame" src="${finalUrl}" allow="autoplay; fullscreen; picture-in-picture; encrypted-media" style="border:none; width:100%; height:100%;"></iframe>`;
            
            setTimeout(() => {
                try {
                    const iframe = document.getElementById('activeFrame');
                    if(iframe && window.playerjs) {
                        playerInstance = new playerjs.Player(iframe);
                        playerInstance.on('ready', () => {
                            playerInstance.getDuration((d) => { if(d > 0) saveDuration(currentPlayingId, d); });
                        });
                        playerInstance.on('timeupdate', (data) => {
                            if(data.duration > 0) saveDuration(currentPlayingId, data.duration);
                        });
                    }
                } catch(err) { console.log("PlayerJS Error:", err); }
            }, 500);

            const btn = document.getElementById('markCompleteBtn');
            if(completedLectures.includes(id)) {
                btn.classList.replace('bg-brand-600', 'bg-green-600');
                btn.innerHTML = '<i class="fa-solid fa-check-double"></i> <span>Ù…ÙƒÙ…Ù„Ù‡Ø§ Ø§Ù†Øª</span>';
            } else {
                btn.classList.replace('bg-green-600', 'bg-brand-600');
                btn.innerHTML = '<i class="fa-solid fa-check"></i> <span>ØªÙ…ØŒ ÙƒÙ…Ù„ØªÙ‡Ø§</span>';
            }

            localStorage.setItem('hameed_lastWatched', JSON.stringify({title, url, id}));
            checkLastWatched();
        }

        function closeVideoModal() {
            if(playerInstance) { try { playerInstance.off('ready'); playerInstance.off('timeupdate'); } catch(e){} playerInstance = null; }
            const modal = document.getElementById('videoModal');
            modal.classList.add('opacity-0');
            setTimeout(()=>{
                modal.classList.add('hidden');
                document.getElementById('videoContainer').innerHTML = '';
            }, 300);
        }

        function completeFromPlayer() {
            if(currentPlayingId) {
                if(!completedLectures.includes(currentPlayingId)) toggleComplete(currentPlayingId);
                closeVideoModal();
            }
        }

        function checkLastWatched() {
            const last = JSON.parse(localStorage.getItem('hameed_lastWatched'));
            if(last) {
                document.getElementById('resumeContainer').classList.remove('hidden');
                document.getElementById('resumeTitle').innerText = last.title;
            }
        }
        function resumeLastWatched() {
            const last = JSON.parse(localStorage.getItem('hameed_lastWatched'));
            if(last) openPlayer(last.title, last.url, last.id);
        }
        function updateStats() {
            let total = 0; allData.forEach(t => t.classes.forEach(c => total += c.lectures.length));
            const count = completedLectures.length;
            const percent = total ? Math.round((count/total)*100) : 0;
            document.getElementById('percentageText').innerText = `${percent}%`;
        }
        function updateSmartSchedule() {
            const container = document.getElementById('scheduleContent');
            const card = document.getElementById('smartScheduleCard');
            let pendingLectures = [];
            allData.forEach(t => t.classes.forEach(c => c.lectures.forEach(l => {
                if (!completedLectures.includes(l.id)) pendingLectures.push({ title: l.title, id: l.id });
            })));
            if (pendingLectures.length === 0) { card.classList.add('hidden'); return; }
            const nextUp = pendingLectures.slice(0, 4); // Show more items on desktop
            let currentTime = new Date();
            currentTime.setMinutes(currentTime.getMinutes() + 10);
            let html = '';
            nextUp.forEach((lec, index) => {
                const timeString = currentTime.toLocaleTimeString('ar-IQ', { hour: 'numeric', minute: '2-digit' });
                html += `
                    <div class="flex items-center justify-between bg-slate-50 p-3 rounded-xl hover:bg-slate-100 transition-colors border border-slate-100">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-white flex items-center justify-center text-brand-600 font-bold text-xs border border-slate-200 shadow-sm">${index + 1}</div>
                            <div class="min-w-0">
                                <p class="font-bold text-sm text-slate-800 line-clamp-1">${lec.title}</p>
                                <p class="text-[10px] text-slate-400">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø³Ø§Ø¹Ø©: <span class="text-slate-600 font-bold dir-ltr">${timeString}</span></p>
                            </div>
                        </div>
                    </div>`;
                currentTime.setHours(currentTime.getHours() + 1);
            });
            container.innerHTML = html;
            card.classList.remove('hidden');
        }
        function triggerConfetti() {
            const c = document.getElementById('confetti-canvas');
            const x = c.getContext('2d');
            c.width = innerWidth; c.height = innerHeight;
            let p = Array(50).fill().map(()=>({x:c.width/2,y:c.height/2,vx:(Math.random()-.5)*20,vy:(Math.random()-.5)*20,color:`hsl(${Math.random()*360},100%,50%)`,life:100}));
            function anim(){
                x.clearRect(0,0,c.width,c.height);
                p=p.filter(i=>i.life-->0);
                p.forEach(i=>{i.x+=i.vx;i.y+=i.vy;i.vy+=.5;x.fillStyle=i.color;x.fillRect(i.x,i.y,5,5)});
                if(p.length)requestAnimationFrame(anim);
            }
            anim();
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            if(!val) renderApp(allData);
            else {
                const filtered = allData.map(t => ({
                    ...t, classes: t.classes.map(c => ({
                        ...c, lectures: c.lectures.filter(l => l.title.toLowerCase().includes(val))
                    })).filter(c => c.lectures.length)
                })).filter(t => t.classes.length);
                renderApp(filtered);
            }
        });

        if(localStorage.getItem('hameed_loggedIn')==='true') {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            loadData();
        }
    </script>
</body>
</html>
